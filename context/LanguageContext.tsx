import React, { createContext, useState, useContext, ReactNode, useEffect, useCallback } from 'react';

type Language = 'en' | 'pt';

interface LanguageContextType {
    language: Language;
    setLanguage: (language: Language) => void;
    t: (key: string, replacements?: { [key: string]: string }) => string;
}

const translations: { [lang in Language]: { [key: string]: string } } = {
  en: {
    explorer: "Explore",
    discoverTitle: "Discover",
    quizTitle: "Gaming Hub",
    startQuiz: "Start Quiz",
    battleTitle: "Battle of Nations",
    battleSubtitle: "Strategic card duel against local AI",
    missionsTitle: "Passport Missions",
    missionsSubtitle: "Weekly goals to boost your rank",
    hallOfFameTitle: "Global Hall of Fame",
    hallOfFameSubtitle: "Top ranked vexillologists",
    backToHub: "Back to Hub",
    backToMenu: "Back to Menu",
    chooseMode: "Choose Game Mode",
    selectDifficulty: "Difficulty",
    difficultyEasy: "Beginner",
    difficultyMedium: "Standard",
    difficultyHard: "Expert",
    nextQuestion: "Next Question",
    quizResults: "Results",
    playAgain: "Play Again",
    attributePop: "Population",
    attributeArea: "Area",
    playerWins: "You Won!",
    aiWins: "AI Won!",
    draw: "Draw!",
    battleVs: "VS",
    aiRival: "AI Rival",
    chooseYourNation: "Choose a Nation",
    missionExploration: "The Explorer: View 20 flags",
    missionQuizMaster: "Quiz Master: Complete 5 quizzes",
    missionCollector: "Collector: Favorite 10 flags",
    flagFactsTitle: "Flag Trivia",
    flagFactsList: '["The flag of **Nepal** is the only non-rectangular national flag.", "The flag of **Denmark** is the oldest continuously used flag.", "The **stars** on Brazil\'s flag represent the sky over Rio in 1889.", "**Switzerland** and the **Vatican** have the only square flags.", "**Mozambique** features an AK-47 on its flag."]',
    showAnotherFact: "New Fact",
    modeFlagToCountry: "Flag ➔ Country",
    modeFlagToCountryDesc: "Identify the nation associated with the displayed flag.",
    modeCountryToFlag: "Country ➔ Flag",
    modeCountryToFlagDesc: "Select the correct flag for the indicated nation.",
    modeFlagToCapital: "Flag ➔ Capital",
    modeFlagToCapitalDesc: "Identify a capital city based on the national flag.",
    modeCountryToCapital: "Country ➔ Capital",
    modeCountryToCapitalDesc: "Relationship between the sovereign state and its capital.",
    modeShapeToCountry: "Heraldry ➔ Country",
    modeShapeToCountryDesc: "Identify the nation through its official Coat of Arms.",
    modeOddOneOut: "The Intruder",
    modeOddOneOutDesc: "Find the flag that doesn't belong to the region.",
    modeFlagle: "Flagle (Pixelated)",
    modeFlagleDesc: "Guess the hidden country behind a low-resolution flag.",
    selectNumberOfQuestions: "Number of Questions",
    allQuestions: "Marathon",
    headerTitle: "World Flags",
    exploreSubtitle: "Discover the history and symbolism of nations.",
    showingFlags: "Showing {{count}} of {{total}}",
    sortBy: "Sort by",
    sortNameAsc: "Name A-Z",
    sortNameDesc: "Name Z-A",
    sortPopAsc: "Pop Asc",
    sortPopDesc: "Pop Desc",
    sortAreaAsc: "Area Asc",
    sortAreaDesc: "Area Desc",
    noFlagsFound: "No flags found",
    noFlagsFoundDescription: "Try a different filter.",
    searchPlaceholder: "Search country...",
    footerRights: "© Flags Explorer",
    footerBuiltWith: "Built with React",
    level: "Level",
    xp: "XP",
    flagsViewed: "Viewed",
    perfectQuizzes: "Perfects",
    maxStreak: "Max Streak",
    designs: "Designs",
    favorites: "Favorites",
    vexMastery: "Vex Mastery",
    rankVexillologist: "Vexillologist",
    totalXP: "Total XP",
    nextLevelAt: "Next level at {{xp}}",
    cat_explorer: "Explorer",
    cat_quiz: "Quiz Master",
    cat_collector: "Collector",
    cat_designer: "Designer",
    rarityCommon: "Common",
    rarityRare: "Rare",
    rarityEpic: "Epic",
    rarityLegendary: "Legendary",
    progress: "Progress",
    dataManagement: "Data",
    exportData: "Export",
    importData: "Import",
    resetData: "Reset",
    resetConfirm: "Are you sure? This deletes everything.",
    dataImported: "Data imported!",
    capital: "Capital",
    population: "Population",
    area: "Area",
    continents: "Continent",
    coatOfArms: "Coat of Arms",
    viewOnMap: "Google Maps",
    closeModal: "Close",
    explored: "Explored",
    addedToFavoritesToast: "Added {{countryName}}",
    removedFromFavoritesToast: "Removed {{countryName}}",
    clearSelection: "Clear",
    selectACountry: "Pick one...",
    compareFlags: "Compare ({{count}})",
    comparisonTitle: "Side by Side",
    all: "All",
    addedToFavorites: "Saved!",
    removedFromFavorites: "Removed!",
    guessesLabel: "Guesses",
    youWonLabel: "Victory!",
    correctAnswerWasLabel: "The answer was:",
    gameOver: "Game Over",
    enterCountryName: "Type name...",
    hintNameStarts: "Starts with",
    hintRegion: "Region:",
    excellentLabel: "Excellent!",
    scrollLeft: "Left",
    scrollRight: "Right",
    filterByContinent: "By Continent",
    filterAndSearch: "Search & Filters",
    randomize: "Random",
    compareMode: "Compare",
    compareModeTooltip: "Pick two to compare",
    flagDesignerTitle: "Designer",
    flagDesignerSubtitle: "Create your flag",
    layout: "Layout",
    colors: "Colors",
    symbol: "Symbol",
    actions: "Actions",
    download: "Download",
    bicolorHorizontal: "Horizontal Bicolor",
    bicolorVertical: "Vertical Bicolor",
    tricolorHorizontal: "Horizontal Tricolor",
    tricolorVertical: "Vertical Tricolor",
    nordicCross: "Nordic Cross",
    noSymbol: "None",
    star: "Star",
    circle: "Circle",
    symbolSun: "Sun",
    symbolCrescent: "Crescent",
    symbolCross: "Cross",
    symbolStar: "Star",
    symbolAnimal: "Animal",
    symbolWeapon: "Weapon",
    symbolBuilding: "Building",
    symbolismExplorerTitle: "Symbolism",
    noFlagsForSymbol: "No flags with this symbol",
    flagOfTheDay: "Flag of the Day",
    discoverIntro: "Dive into world patterns.",
    uniqueFlagOfTheDayTitle: "Focus",
    achievementsSubtitle: "Your milestones.",
    notAvailable: "N/A",
    colorN: "Color {{n}}",
    mainColor: "Primary",
    crossColor: "Cross",
    symbolColor: "Symbol Color",
    showingFlagsWith: "Flags with {{color}}",
    noFlagsForColor: "No matching flags",
    filterByColor: "By Color",
    aiEnhanced: "Enhanced AI Mode",
    vexyGreeting: "Hello! I am Vexy, your AI guide through the world of flags. What would you like to discover today?",
    askVexy: "Ask Vexy something...",
    classicModes: "Classic Modes",
    whichCountry: "Which country is this?",
    goToTop: "Back to top",
    you: "You",
    achFirstStepsTitle: "First Steps",
    achFirstStepsDesc: "View your first flag details.",
    achWorldTravelerTitle: "World Traveler",
    achWorldTravelerDesc: "View 50 different flags.",
    achCenturyClubTitle: "Century Club",
    achCenturyClubDesc: "View 100 different flags.",
    achVexExpertTitle: "Vexillology Expert",
    achVexExpertDesc: "View 150 different flags.",
    achVexScholarTitle: "Vex Scholar",
    achVexScholarDesc: "View 200 different flags.",
    achMasterExplorerTitle: "Master Explorer",
    achMasterExplorerDesc: "View almost every flag in the world.",
    achAfricanSpecialistTitle: "African Specialist",
    achAfricanSpecialistDesc: "View 20 flags from Africa.",
    achAsianSpecialistTitle: "Asian Specialist",
    achAsianSpecialistDesc: "View 20 flags from Asia.",
    achEuropeanSpecialistTitle: "European Specialist",
    achEuropeanSpecialistDesc: "View 20 flags from Europe.",
    achAmericanSpecialistTitle: "American Specialist",
    achAmericanSpecialistDesc: "View 20 flags from the Americas.",
    achOceanianSpecialistTitle: "Oceanian Specialist",
    achOceanianSpecialistDesc: "View 10 flags from Oceania.",
    achCuriousMindTitle: "Curious Mind",
    achCuriousMindDesc: "Interact with the database multiple times.",
    achAIExpertTitle: "AI Consultant",
    achAIExpertDesc: "Ask Vexy for help 25 times.",
    achQuizStarterTitle: "Fresh Recruit",
    achQuizStarterDesc: "Complete your first quiz.",
    achQuizScholarTitle: "Knowledge Seeker",
    achQuizScholarDesc: "Complete 10 quizzes.",
    achQuizMarathonerTitle: "Marathon Runner",
    achQuizMarathonerDesc: "Complete 50 quizzes.",
    achQuizVeteranTitle: "Vex Veteran",
    achQuizVeteranDesc: "Complete 100 quizzes.",
    achQuizTitanTitle: "Vexillology Titan",
    achQuizTitanDesc: "Complete 250 quizzes.",
    achStreakMasterTitle: "On Fire",
    achStreakMasterDesc: "Get a streak of 10 correct answers.",
    achStreakGodlikeTitle: "Godlike",
    achStreakGodlikeDesc: "Get a streak of 25 correct answers.",
    achStreakUnrealTitle: "Unreal Performance",
    achStreakUnrealDesc: "Get a streak of 100 correct answers.",
    achPerfectScoreTitle: "Flawless Victory",
    achPerfectScoreDesc: "Get 100% correct in a quiz.",
    achPerfectLegendTitle: "Living Legend",
    achPerfectLegendDesc: "Get 10 perfect quiz results.",
    achCuratorTitle: "Flag Curator",
    achCuratorDesc: "Favorite 10 different flags.",
    achCollectorProTitle: "Professional Collector",
    achCollectorProDesc: "Favorite 25 different flags.",
    achWorldCuratorTitle: "World Curator",
    achWorldCuratorDesc: "Favorite 50 different flags.",
    achCollectionMasterTitle: "Collection Master",
    achCollectionMasterDesc: "Favorite 75 different flags.",
    achAnalystTitle: "Data Analyst",
    achAnalystDesc: "Compare flags 10 times.",
    achMasterAnalystTitle: "Master Analyst",
    achMasterAnalystDesc: "Compare flags 50 times.",
    achJudgeMaestroTitle: "Judge Maestro",
    achJudgeMaestroDesc: "Compare flags 100 times."
  },
  pt: {
    explorer: "Explorar",
    discoverTitle: "Descobrir",
    quizTitle: "Central de Jogos",
    startQuiz: "Iniciar Quiz",
    battleTitle: "Batalha de Nações",
    battleSubtitle: "Duelo estratégico de cartas contra IA local",
    missionsTitle: "Missões do Passaporte",
    missionsSubtitle: "Metas semanais para subir de nível",
    hallOfFameTitle: "Ranking Global",
    hallOfFameSubtitle: "Os melhores vexilologistas da rede",
    backToHub: "Voltar para o Hub",
    backToMenu: "Voltar para o Menu",
    chooseMode: "Escolha o Modo de Jogo",
    selectDifficulty: "Dificuldade",
    difficultyEasy: "Iniciante",
    difficultyMedium: "Padrão",
    difficultyHard: "Especialista",
    nextQuestion: "Próxima Pergunta",
    quizResults: "Resultados",
    playAgain: "Jogar Novamente",
    attributePop: "População",
    attributeArea: "Área",
    playerWins: "Você Venceu!",
    aiWins: "IA Venceu!",
    draw: "Empate!",
    battleVs: "VS",
    aiRival: "Rival IA",
    chooseYourNation: "Escolha sua Nação",
    missionExploration: "O Explorador: Veja 20 bandeiras",
    missionQuizMaster: "Mestre do Quiz: Complete 5 quizzes",
    missionCollector: "Colecionador: Favorite 10 bandeiras",
    flagFactsTitle: "Curiosidades",
    flagFactsList: '["A bandeira do **Nepal** é a única não retangular.", "A bandeira da **Dinamarca** é a mais antiga em uso.", "As **estrelas** do Brasil representam o céu de 1889.", "**Suíça** e **Vaticano** possuem as únicas bandeiras quadradas.", "**Moçambique** tem uma AK-47 em sua bandeira."]',
    showAnotherFact: "Nova Curiosidade",
    modeFlagToCountry: "Bandeira ➔ País",
    modeFlagToCountryDesc: "Identifique a nação associada à bandeira exibida.",
    modeCountryToFlag: "País ➔ Bandeira",
    modeCountryToFlagDesc: "Selecione a bandeira correta para a nação indicada.",
    modeFlagToCapital: "Bandeira ➔ Capital",
    modeFlagToCapitalDesc: "Identifique uma capital com base na bandeira nacional.",
    modeCountryToCapital: "País ➔ Capital",
    modeCountryToCapitalDesc: "Relação do estado soberano com sua respectiva capital.",
    modeShapeToCountry: "Heráldica ➔ País",
    modeShapeToCountryDesc: "Identifique a nação através do seu Brasão de Armas oficial.",
    modeOddOneOut: "O Intruso",
    modeOddOneOutDesc: "Encontre a bandeira que não pertence à região exibida.",
    modeFlagle: "Flagle (Desafio Pixelado)",
    modeFlagleDesc: "Adivinhe o país oculto por trás de uma bandeira em baixa resolução.",
    selectNumberOfQuestions: "Número de Questões",
    allQuestions: "Maratona",
    headerTitle: "Bandeiras do Mundo",
    exploreSubtitle: "Descubra a história e o simbolismo das nações.",
    showingFlags: "Exibindo {{count}} de {{total}}",
    sortBy: "Ordenar por",
    sortNameAsc: "Nome A-Z",
    sortNameDesc: "Nome Z-A",
    sortPopAsc: "Pop Cresc",
    sortPopDesc: "Pop Decresc",
    sortAreaAsc: "Área Cresc",
    sortAreaDesc: "Área Decresc",
    noFlagsFound: "Bandeiras não encontradas",
    noFlagsFoundDescription: "Tente um filtro diferente.",
    searchPlaceholder: "Pesquisar país...",
    footerRights: "© Explorador de Bandeiras",
    footerBuiltWith: "Desenvolvido com React",
    level: "Nível",
    xp: "XP",
    flagsViewed: "Vistas",
    perfectQuizzes: "Gabaritos",
    maxStreak: "Sequência Máx.",
    designs: "Criações",
    favorites: "Favoritos",
    vexMastery: "Domínio Vex",
    rankVexillologist: "Vexilologista",
    totalXP: "XP Total",
    nextLevelAt: "Próximo nível em {{xp}}",
    cat_explorer: "Explorador",
    cat_quiz: "Mestre do Quiz",
    cat_collector: "Colecionador",
    cat_designer: "Designer",
    rarityCommon: "Comum",
    rarityRare: "Rara",
    rarityEpic: "Épica",
    rarityLegendary: "Lendária",
    progress: "Progresso",
    dataManagement: "Dados",
    exportData: "Exportar",
    importData: "Importar",
    resetData: "Reiniciar",
    resetConfirm: "Tem certeza? Isso apaga tudo.",
    dataImported: "Dados importados!",
    capital: "Capital",
    population: "População",
    area: "Área",
    continents: "Continente",
    coatOfArms: "Brasão",
    viewOnMap: "Google Maps",
    closeModal: "Fechar",
    explored: "Explorado",
    addedToFavoritesToast: "Adicionado: {{countryName}}",
    removedFromFavoritesToast: "Removido: {{countryName}}",
    clearSelection: "Limpar",
    selectACountry: "Escolha um...",
    compareFlags: "Comparar ({{count}})",
    comparisonTitle: "Lado a Lado",
    all: "Todos",
    addedToFavorites: "Salvo!",
    removedFromFavorites: "Removido!",
    guessesLabel: "Palpites",
    youWonLabel: "Vitória!",
    correctAnswerWasLabel: "A resposta era:",
    gameOver: "Fim de Jogo",
    enterCountryName: "Digite o nome...",
    hintNameStarts: "Começa com",
    hintRegion: "Região:",
    excellentLabel: "Excelente!",
    scrollLeft: "Esquerda",
    scrollRight: "Direita",
    filterByContinent: "Por Continente",
    filterAndSearch: "Busca & Filtros",
    randomize: "Aleatório",
    compareMode: "Comparar",
    compareModeTooltip: "Escolha duas para comparar",
    flagDesignerTitle: "Designer",
    flagDesignerSubtitle: "Crie sua bandeira",
    layout: "Layout",
    colors: "Cores",
    symbol: "Símbolo",
    actions: "Ações",
    download: "Baixar",
    bicolorHorizontal: "Bicolor Horizontal",
    bicolorVertical: "Bicolor Vertical",
    tricolorHorizontal: "Tricolor Horizontal",
    tricolorVertical: "Tricolor Vertical",
    nordicCross: "Cruz Nórdica",
    noSymbol: "Nenhum",
    star: "Estrela",
    circle: "Círculo",
    symbolSun: "Sol",
    symbolCrescent: "Crescente",
    symbolCross: "Cruz",
    symbolStar: "Estrela",
    symbolAnimal: "Animal",
    symbolWeapon: "Arma",
    symbolBuilding: "Construção",
    symbolismExplorerTitle: "Simbolismo",
    noFlagsForSymbol: "Sem bandeiras com este símbolo",
    flagOfTheDay: "Bandeira do Dia",
    discoverIntro: "Mergulhe nos padrões mundiais.",
    uniqueFlagOfTheDayTitle: "Foco",
    achievementsSubtitle: "Seus marcos.",
    notAvailable: "N/D",
    colorN: "Cor {{n}}",
    mainColor: "Principal",
    crossColor: "Cruz",
    symbolColor: "Cor do Símbolo",
    showingFlagsWith: "Bandeiras com {{color}}",
    noFlagsForColor: "Sem bandeiras correspondentes",
    filterByColor: "Por Cor",
    aiEnhanced: "Modo IA Aprimorado",
    vexyGreeting: "Olá! Sou o Vexy, seu guia de inteligência artificial pelo mundo das bandeiras. O que você quer descobrir hoje?",
    askVexy: "Fale com o Vexy...",
    classicModes: "Modos Clássicos",
    whichCountry: "Qual é este país?",
    goToTop: "Ir para o topo",
    you: "Você",
    achFirstStepsTitle: "Primeiros Passos",
    achFirstStepsDesc: "Veja os detalhes da sua primeira bandeira.",
    achWorldTravelerTitle: "Viajante do Mundo",
    achWorldTravelerDesc: "Veja 50 bandeiras diferentes.",
    achCenturyClubTitle: "Clube dos Cem",
    achCenturyClubDesc: "Veja 100 bandeiras diferentes.",
    achVexExpertTitle: "Especialista Vex",
    achVexExpertDesc: "Veja 150 bandeiras diferentes.",
    achVexScholarTitle: "Estudioso Vex",
    achVexScholarDesc: "Veja 200 bandeiras diferentes.",
    achMasterExplorerTitle: "Mestre Explorador",
    achMasterExplorerDesc: "Veja quase todas as bandeiras do mundo.",
    achAfricanSpecialistTitle: "Especialista em África",
    achAfricanSpecialistDesc: "Veja 20 bandeiras da África.",
    achAsianSpecialistTitle: "Especialista em Ásia",
    achAsianSpecialistDesc: "Veja 20 bandeiras da Ásia.",
    achEuropeanSpecialistTitle: "Especialista em Europa",
    achEuropeanSpecialistDesc: "Veja 20 bandeiras da Europa.",
    achAmericanSpecialistTitle: "Especialista em Américas",
    achAmericanSpecialistDesc: "Veja 20 bandeiras das Américas.",
    achOceanianSpecialistTitle: "Especialista em Oceania",
    achOceanianSpecialistDesc: "Veja 10 bandeiras da Oceania.",
    achCuriousMindTitle: "Mente Curiosa",
    achCuriousMindDesc: "Interaja com o banco de dados várias vezes.",
    achAIExpertTitle: "Consultor de IA",
    achAIExpertDesc: "Peça ajuda ao Vexy 25 vezes.",
    achQuizStarterTitle: "Recruta",
    achQuizStarterDesc: "Complete seu primeiro quiz.",
    achQuizScholarTitle: "Buscador de Saber",
    achQuizScholarDesc: "Complete 10 quizzes.",
    achQuizMarathonerTitle: "Maratonista",
    achQuizMarathonerDesc: "Complete 50 quizzes.",
    achQuizVeteranTitle: "Veterano Vex",
    achQuizVeteranDesc: "Complete 100 quizzes.",
    achQuizTitanTitle: "Titã da Vexilologia",
    achQuizTitanDesc: "Complete 250 quizzes.",
    achStreakMasterTitle: "Em Chamas",
    achStreakMasterDesc: "Consiga uma sequência de 10 acertos.",
    achStreakGodlikeTitle: "Divino",
    achStreakGodlikeDesc: "Consiga uma sequência de 25 acertos.",
    achStreakUnrealTitle: "Inacreditável",
    achStreakUnrealDesc: "Consiga uma sequência de 100 acertos.",
    achPerfectScoreTitle: "Vitória Perfeita",
    achPerfectScoreDesc: "Acerte 100% de um quiz.",
    achPerfectLegendTitle: "Lenda Viva",
    achPerfectLegendDesc: "Consiga 10 gabaritos perfeitos.",
    achCuratorTitle: "Curador de Bandeiras",
    achCuratorDesc: "Favorite 10 bandeiras diferentes.",
    achCollectorProTitle: "Colecionador Pro",
    achCollectorProDesc: "Favorite 25 bandeiras diferentes.",
    achWorldCuratorTitle: "Curador Mundial",
    achWorldCuratorDesc: "Favorite 50 bandeiras diferentes.",
    achCollectionMasterTitle: "Mestre da Coleção",
    achCollectionMasterDesc: "Favorite 75 bandeiras diferentes.",
    achAnalystTitle: "Analista de Dados",
    achAnalystDesc: "Compare bandeiras 10 vezes.",
    achMasterAnalystTitle: "Mestre Analista",
    achMasterAnalystDesc: "Compare bandeiras 50 vezes.",
    achJudgeMaestroTitle: "Maestro do Julgamento",
    achJudgeMaestroDesc: "Compare bandeiras 100 vezes."
  }
};

const LanguageContext = createContext<LanguageContextType | undefined>(undefined);

export const LanguageProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
    const [language, setLanguageState] = useState<Language>(() => {
        const saved = localStorage.getItem('language');
        if (saved === 'en' || saved === 'pt') return saved;
        return navigator.language.startsWith('pt') ? 'pt' : 'en';
    });

    const setLanguage = useCallback((lang: Language) => {
        setLanguageState(lang);
        localStorage.setItem('language', lang);
        document.documentElement.lang = lang;
    }, []);

    useEffect(() => {
        document.documentElement.lang = language;
    }, [language]);

    const t = useCallback((key: string, replacements?: { [key: string]: string }) => {
        let text = translations[language][key] || translations['en'][key] || key;
        
        if (replacements) {
            Object.entries(replacements).forEach(([k, v]) => {
                text = text.replace(`{{${k}}}`, v);
            });
        }
        
        return text;
    }, [language]);

    return (
        <LanguageContext.Provider value={{ language, setLanguage, t }}>
            {children}
        </LanguageContext.Provider>
    );
};

export const useLanguage = () => {
    const context = useContext(LanguageContext);
    if (context === undefined) {
        throw new Error('useLanguage must be used within a LanguageProvider');
    }
    return context;
};
